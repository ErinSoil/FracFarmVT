sig_list <- list()
for (var in responses) {
# Remove NA rows for the current variable
data_var <- data_filtered %>% filter(!is.na(.data[[var]]))
# Need at least 2 factor levels
if (length(unique(data_var$Type.x)) < 2) next
# Fit GLS model
model <- gls(as.formula(paste(var, "~ Type.x")),
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude)
# ---------  ANOVA PART (always store, even if non-significant) ---------
a <- anova(model)
if ("Type.x" %in% rownames(a)) {
F_val <- a["Type.x", "F-value"]
df1   <- a["Type.x", "numDF"]
df2   <- a["Type.x", "denDF"]
p_val <- a["Type.x", "p-value"]
} else {
# In case the row is missing (rare), set NA
F_val <- df1 <- df2 <- p_val <- NA
}
anova_results <- rbind(
anova_results,
data.frame(
response = var,
F_value = F_val,
df1 = df1,
df2 = df2,
p_value = p_val
)
)
# --------- Your Tukey code (unchanged) ---------
emm <- emmeans(model, specs = "Type.x", mode = "df.error")
pw <- pairs(emm, adjust = "tukey") %>% summary()
sig_pw <- pw %>% as.data.frame() %>% filter(p.value < 0.05)
if (nrow(sig_pw) > 0) {
sig_pw$response <- var
sig_list[[var]] <- sig_pw
}
}
# Filter data and convert Type.x to factor
data_filtered <- data %>%
filter(Type.x != "Field crops") %>%
mutate(Type.x = factor(Type.x))
responses <- c("tmeanC", "ppt.cm", "aggregate_stability",
"active_carbon", "ph", "overall.score", "soil_texture_clay")
anova_results <- list()
sig_list <- list()
for (var in responses) {
data_var <- data_filtered %>% filter(!is.na(.data[[var]]))
if (length(unique(data_var$Type.x)) < 2) next
model <- gls(as.formula(paste(var, "~ Type.x")),
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude)
# ===============================
#   SAFE ANOVA EXTRACTOR
# ===============================
a <- anova(model)
if ("Type.x" %in% rownames(a)) {
F_val <- a["Type.x", "F-value"]
df1   <- a["Type.x", "numDF"]
df2   <- a["Type.x", "denDF"]
p_val <- a["Type.x", "p-value"]
} else {
# Guarantee length-1 values
F_val <- NA_real_
df1   <- NA_real_
df2   <- NA_real_
p_val <- NA_real_
}
anova_results[[var]] <- data.frame(
response = var,
F_value = F_val,
df1 = df1,
df2 = df2,
p_value = p_val
)
# ===============================
#   Tukey (unchanged)
# ===============================
emm <- emmeans(model, specs = "Type.x", mode = "df.error")
pw <- pairs(emm, adjust = "tukey") %>% summary()
sig_pw <- pw %>% as.data.frame() %>% filter(p.value < 0.05)
if (nrow(sig_pw) > 0) {
sig_pw$response <- var
sig_list[[var]] <- sig_pw
}
}
library(nlme)
library(dplyr)
library(emmeans)
anova_results <- list()
sig_list <- list()
for (var in responses) {
# Subset non-NA data
data_var <- data_filtered %>% filter(!is.na(.data[[var]]))
if (length(unique(data_var$Type.x)) < 2) next
# Fit model
model <- gls(
as.formula(paste(var, "~ Type.x")),
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
# -----------------------------
# SAFE ANOVA SECTION
# -----------------------------
a <- tryCatch(anova(model), error = function(e) NULL)
if (is.null(a) || nrow(a) == 0) {
# Completely empty ANOVA table → return NA row
F_val <- NA_real_
df1   <- NA_real_
df2   <- NA_real_
p_val <- NA_real_
} else if ("Type.x" %in% rownames(a)) {
# Normal case
F_val <- a["Type.x", "F-value"]
df1   <- a["Type.x", "numDF"]
df2   <- a["Type.x", "denDF"]
p_val <- a["Type.x", "p-value"]
} else {
# ANOVA ran but no Type.x row
F_val <- NA_real_
df1   <- NA_real_
df2   <- NA_real_
p_val <- NA_real_
}
# Add to list
anova_results[[var]] <- data.frame(
response = var,
F_value = F_val,
df1     = df1,
df2     = df2,
p_value = p_val
)
# -----------------------------
# Tukey section (same as before)
# -----------------------------
emm <- emmeans(model, specs = "Type.x", mode = "df.error")
pw <- pairs(emm, adjust = "tukey") %>% summary()
sig_pw <- pw %>% as.data.frame() %>% filter(p.value < 0.05)
if (nrow(sig_pw) > 0) {
sig_pw$response <- var
sig_list[[var]] <- sig_pw
}
}
# Filter data and convert Type.x to factor
data_filtered <- data %>%
filter(Type.x != "Field crops") %>%
mutate(Type.x = factor(Type.x))
responses <- c("tmeanC", "ppt.cm", "aggregate_stability",
"active_carbon", "ph", "overall.score", "soil_texture_clay")
sig_list <- list()
for(var in responses){
# Pre-filter NAs
data_var <- data_filtered %>% filter(!is.na(.data[[var]]))
if(length(unique(data_var$Type.x)) < 2) next
# Fit GLS with variance structure
model <- gls(as.formula(paste(var, "~ Type.x")),
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude)
# Estimated marginal means
emm <- emmeans(model, specs = "Type.x", mode = "df.error")
# Tukey pairwise comparisons
pw <- pairs(emm, adjust = "tukey") %>% summary()
# Keep only significant comparisons (p < 0.05)
sig_pw <- pw %>% as.data.frame() %>% filter(p.value < 0.05)
if(nrow(sig_pw) > 0){
sig_pw$response <- var
sig_list[[var]] <- sig_pw
}
}
# Combine all significant pairwise differences
sig_differences <- bind_rows(sig_list)
# View results
sig_differences
#####show all, even without significance
# Filter data and convert Type.x to factor
data_filtered <- data %>%
filter(Type.x != "Field crops") %>%
mutate(Type.x = factor(Type.x))
responses <- c("tmeanC", "ppt.cm", "aggregate_stability",
"active_carbon", "ph", "overall.score", "soil_texture_clay")
all_pw_list <- list()
for (var in responses) {
# Remove NAs for this variable
data_var <- data_filtered %>% filter(!is.na(.data[[var]]))
# If only one level left, skip
if (length(unique(data_var$Type.x)) < 2) next
# Fit GLS
model <- gls(
as.formula(paste(var, "~ Type.x")),
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
# Estimated marginal means
emm <- emmeans(model, specs = "Type.x", mode = "df.error")
# Tukey comparisons for *all* pairs
pw <- pairs(emm, adjust = "tukey") %>% summary()
# Convert to dataframe and add response label
pw_df <- pw %>% as.data.frame() %>% mutate(response = var)
all_pw_list[[var]] <- pw_df
}
# Combine all into one dataframe
all_pairwise <- bind_rows(all_pw_list)
# View
all_pairwise
library(dplyr)
library(emmeans)
library(nlme)
library(multcomp)
library(openxlsx)
# ------------------------
# Filter data
# ------------------------
data_filtered <- data %>%
filter(Type.x != "Field crops") %>%
mutate(Type.x = factor(Type.x))
responses <- c("tmeanC", "ppt.cm", "aggregate_stability",
"active_carbon", "ph", "overall.score", "soil_texture_clay")
all_pw_list <- list()
# ------------------------
# Loop through all variables
# ------------------------
for (var in responses) {
# Remove NAs only for the current variable
data_var <- data_filtered %>%
filter(!is.na(.data[[var]]))
# Skip if only one crop type remains
if (length(unique(data_var$Type.x)) < 2) next
# GLS model
model <- gls(
as.formula(paste(var, "~ Type.x")),
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
# Estimated marginal means
emm <- emmeans(model, specs = "Type.x", mode = "df.error")
# Tukey comparisons (all)
pw <- pairs(emm, adjust = "tukey") %>% summary()
pw_df <- pw %>% as.data.frame()
# ------------------------
# Format statistics: t(df) = value, p = value
# ------------------------
pw_df$stat_formatted <- paste0(
"t(df = ", round(pw_df$df, 2),
") = ", round(pw_df$t.ratio, 2),
", p = ", signif(pw_df$p.value, 3)
)
pw_df$response <- var
all_pw_list[[var]] <- pw_df
}
# Combine results
all_pairwise <- bind_rows(all_pw_list)
# ------------------------
# Reorder columns neatly
# ------------------------
all_pairwise_clean <- all_pairwise %>%
select(response, contrast, estimate, SE, df, t.ratio, p.value, stat_formatted)
# ------------------------
# Write to Excel
# ------------------------
wb <- createWorkbook()
addWorksheet(wb, "Tukey_All")
writeData(wb, "Tukey_All", all_pairwise_clean)
saveWorkbook(wb, "Tukey_All_Comparisons.xlsx", overwrite = TRUE)
anova (model)
modelMAT <- gls(
as.formula(paste(tmeanC, "~ Type.x")),
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
modelMAT <- gls(
as.formula(paste(tmeanC, "~ Type.x")),
data = data,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
modelMAT <- gls(tmeanC~ Type.x)
modelMAT <- gls(tmeanC~Type.x)
modelMAT <- gls(tmeanC~ Type.x),
modelMAT <- gls(
tmeanC ~ Type.x,
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
anova(modelMAT)
# GLS model
modelMAP <- gls(
ppt.cm ~ Type.x,
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
anova(modelMAP)
# GLS model
modelag <- gls(
aggregate_stability ~ Type.x,
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
anova(modelag)
modelpox <- gls(
active_carbon ~ Type.x,
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
anova(modelpox)
modelpH <- gls(
ph ~ Type.x,
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
anova(modelpH)
modelclay <- gls(
soil_texture_clay ~ Type.x,
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
anova(modelclay)
# GLS model
modelSH <- gls(
overall.score ~ Type.x,
data = data_var,
method = "REML",
weights = varIdent(form = ~1 | Type.x),
na.action = na.exclude
)
anova(modelSH)
#analyze data by field type. group by and color by field type this code is in progress
#exploration
mgMAOM_active_carbonbyField <-data
ggplot() +
geom_point(aes(x = active_carbon, y = mgCpergSoilM, color=Type.x),
size = 1.5, alpha = 0.5) +
#geom_smooth() +
own_theme+
#theme(legend.position = "none") +
scale_y_continuous(expression("mg C in MAOM per g soil"))+
scale_x_continuous(expression("active_carbon"),
label = scales::comma)
own_theme <- theme_bw(base_size = 11) +
theme(rect = element_blank(),
axis.ticks = element_line(color = "black"),
axis.text = element_text(color = "black"),
axis.line = element_line(color = "black"),
panel.grid.minor = element_blank())
data$AP <- as.factor(data$AP)
# Display the plot
claySilt_MAOC
claySilt_MAOC <- claySilt_MAOC +
geom_abline(slope = slope, intercept = 0, color = "red", linetype = "dashed", size = 1.2) +  # Expected slope
geom_abline(slope = slope_upper, intercept = 0, color = "blue", linetype = "dotted", size = 1.2) +  # Upper margin line
geom_abline(slope = slope_lower, intercept = 0, color = "blue", linetype = "dotted", size = 1.2)  # Lower margin line
claySilt_MAOC <- ggplot(data, aes(x = claySilt, y = mgCpergSoilM, color = AP)) +
geom_point(alpha = 0.5) +  # Scatter points
stat_smooth(method = "lm", se = TRUE, color = "black") +  # Add linear regression line with confidence intervals
labs(x = "Clay and Silt Content (%)",
y = expression("mg MAOC g"^-1~"soil")) +  # Y-axis label
own_theme +
# theme_minimal() +  # Minimal theme for aesthetics
theme(#axis.title.x = element_text(size = 12),  # Increase x-axis label size
#axis.title.y = element_text(size = 12),  # Increase y-axis label size
axis.line = element_line(color = "black"),  # Add axis lines
legend.title = element_blank(),  # Remove legend title
legend.position = c(.2,.85)) +  # Position legend on the right
scale_color_manual(values = c("Annual" = "#cd853f", "Perennial" = "darkgreen"))  # Custom colors for annual and perennial
claySilt_MAOC
data <- data %>%
mutate(claySilt = soil_texture_clay + soil_texture_silt)
unique(data$AP)
data <- data %>%
mutate(AP = case_when(
tolower(AP) == "annual" ~ "Annual",
tolower(AP) == "perennial" ~ "Perennial",
TRUE ~ as.character(AP)
))
unique(data$AP)
data <- data %>%
mutate(AP = case_when(
tolower(AP) == "annual" ~ "Annual",
tolower(AP) == "perennial" ~ "Perennial",
TRUE ~ as.character(AP)
))
#######claysilt with field type
# Create the plot
claySilt_MAOC2 <- ggplot(data, aes(x = claySilt, y = mgCpergSoilM, color = Type.x)) +
geom_point(alpha = 0.5) +  # Scatter points
stat_smooth(method = "lm", se = TRUE, color = "black") +  # Add linear regression line with confidence intervals
labs(x = "Clay and Silt Content (%)",
y = expression("mg MAOC g"^-1~"soil")) +  # Y-axis label
own_theme +
# theme_minimal() +  # Minimal theme for aesthetics
theme(#axis.title.x = element_text(size = 12),  # Increase x-axis label size
#axis.title.y = element_text(size = 12),  # Increase y-axis label size
axis.line = element_line(color = "black"),  # Add axis lines
legend.title = element_blank(),  # Remove legend title
legend.position = c(.2,.85)) +  # Position legend on the right
scale_color_manual(values = c("Annual" = "#cd853f", "Perennial" = "darkgreen"))  # Custom colors for annual and perennial
claySilt_MAOC2
# Add custom lines for expected slope and error margins
slope <- 0.86  # Desired slope
error_margin <- 0.09  # Error margin for slope
# Calculate upper and lower slopes
slope_upper <- slope + error_margin
slope_lower <- slope - error_margin
claySilt_MAOC2 <- claySilt_MAOC2 +
geom_abline(slope = slope, intercept = 0, color = "red", linetype = "dashed", size = 1.2) +  # Expected slope
geom_abline(slope = slope_upper, intercept = 0, color = "blue", linetype = "dotted", size = 1.2) +  # Upper margin line
geom_abline(slope = slope_lower, intercept = 0, color = "blue", linetype = "dotted", size = 1.2)  # Lower margin line
# Display the plot
claySilt_MAOC2
# Standardize factor levels FIRST
data$Type.x <- factor(data$Type.x,
levels = c("Annual", "Perennial"))
claySilt_MAOC2 <- ggplot(data, aes(x = claySilt,
y = mgCpergSoilM,
color = Type.x)) +
geom_point(alpha = 0.5) +
stat_smooth(method = "lm", se = TRUE, color = "black") +
labs(
x = "Clay and Silt Content (%)",
y = expression("mg MAOC g"^-1~"soil")
) +
own_theme +
theme(
axis.line = element_line(color = "black"),
legend.title = element_blank(),
legend.position = c(.2,.85)
) +
scale_color_manual(values = c(
"Annual" = "#cd853f",
"Perennial" = "darkgreen"
))
# Add slope lines
slope <- 0.86
slope_upper <- slope + 0.09
slope_lower <- slope - 0.09
claySilt_MAOC2 +
geom_abline(slope = slope, intercept = 0, color = "red",
linetype = "dashed", size = 1.2) +
geom_abline(slope = slope_upper, intercept = 0, color = "blue",
linetype = "dotted", size = 1.2) +
geom_abline(slope = slope_lower, intercept = 0, color = "blue",
linetype = "dotted", size = 1.2)
claySilt_MAOC2
unique(data$Type.x)
unique(data$Type.x)
##call in the analytical data
data <- read.csv("data.csv")
summary(Type.x)
#setwd("/Users/f003833/Documents/GitHub/FracFarmVT") #caitlin
setwd("C:/Users/F004SPC/Documents/GitHub/FracFarmVT") #erin
##call in the analytical data
data <- read.csv("data.csv")
##call in the analytical data
data <- read.csv("data_pH.csv")
summary(Type.x)
# Perform linear regression
regression_model <- lm(mgCpergSoilM ~ overall.score, data = data)
summary(Type.x)
#setwd("/Users/f003833/Documents/GitHub/FracFarmVT") #caitlin
setwd("C:/Users/F004SPC/Documents/GitHub/FracFarmVT") #erin
##call in the analytical data
data <- read.csv("data_pH.csv")
##call in the analytical data
data <- read.csv("data_pH.csv")
##call in the analytical data
data <- read.csv("data_pH.csv")
##call in the analytical data
data <- read.csv("data_pH.csv")
##call in the analytical data
data <- read.csv("data_pH.csv")
file.edit("~/.Rprofile")
data = data_var,
file.edit(".Rprofile")
getTaskCallbackNames()
##call in the analytical data
data <- read.csv("data_pH.csv")
view(data)
summary(data$ph)
summary(Type.x)
# Perform linear regression
regression_model <- lm(mgCpergSoilM ~ overall.score, data = data)
1 + 1
Code → Folding → Unfold All
Sys.getenv("R_PROFILE_USER")
